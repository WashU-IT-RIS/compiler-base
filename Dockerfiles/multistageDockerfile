# Begin Stage 1 with the base compiler image.
FROM docker.io/intel/hpckit:2024.2.1-0-devel-ubuntu22.04 as build

# Additional dependencies for the IntelÂ® MPI C compiler
# RUN apt-get install -y gcc-c++

# Change working directory
WORKDIR /opt/mpi_hello_world/src/

# Get test file
# RUN wget https://hpc-tutorials.llnl.gov/mpi/examples/mpi_hello.c

# Copy the source code to the working directory
COPY mpi_hello.c .

SETVARS_ARGS="ia32 --force"; export SETVARS_ARGS

# Copy source code to a new location inside the container.
RUN cd /opt/mpi_hello_world/src/ && \
    . /opt/intel/oneapi/setvars.sh && \
    mpiicx -o mpi_hello_world mpi_hello.c && \
    cp -f mpi_hello_world /usr/local/bin

# COPY runmpi /usr/local/bin

# Begin Stage 2 with a new base image.
FROM ubuntu:22.04 as runtime

# Copy only the needed parts of Stage 1.
COPY --from=build /usr/local/bin/mpi_hello_world /usr/local/bin
# COPY --from=build /usr/local/bin/runmpi /usr/local/bin/runmpi



# Add any additional runtime dependencies here
RUN export DEBIAN_FRONTEND=noninteractive && apt-get update && \
        apt-get install -y wget \
        perl
# perl numactl-libs \
#    gtk2 atk cairo gcc-gfortran tcsh libnl3 \
#    libmnl tcl tk \
#    libusbx pciutils-libs pciutils lsof ethtool fuse-libs

# Set up MLNX_OFED driver.
ENV MOFED_VERSION=5.8-6.0.4.2
ENV OS_VERSION=ubuntu22.04
ENV PLATFORM=x86_64
RUN wget -q http://content.mellanox.com/ofed/MLNX_OFED-${MOFED_VERSION}/MLNX_OFED_LINUX-${MOFED_VERSION}-${OS_VERSION}-${PLATFORM}.tgz && \
tar -xvf MLNX_OFED_LINUX-${MOFED_VERSION}-${OS_VERSION}-${PLATFORM}.tgz && \
MLNX_OFED_LINUX-${MOFED_VERSION}-${OS_VERSION}-${PLATFORM}/mlnxofedinstall --user-space-only --without-fw-update -q  --distro ${OS_VERSION} && \
cd .. && \
rm -rf ${MOFED_DIR} && \
rm -rf *.tgz